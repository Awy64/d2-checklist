<div class="childComponent">
  <div class="childVert">
    <div class="main">
      <!-- <p class="simple-caption">
        <span class="warn-text">This is alpha code, still a work in progress</span>
      </p> -->
      <div class="fixed-spinner">
        <mat-spinner class="loading" class="center-spinner" *ngIf="loading===true || gearService.loading===true"></mat-spinner>
        <mat-spinner class="loading" class="center-spinner" *ngIf="filtering===true && !(loading===true || gearService.loading===true)"></mat-spinner>
      </div>

      <mat-button-toggle-group #optionsgroup="matButtonToggleGroup" *ngIf="selectedUser!=null" [value]="option"
        (change)="option=optionsgroup.value; filterChanged()">
        <mat-button-toggle *ngFor="let o of options" [value]="o">
          <i *ngIf="o.name=='Weapons'" class="far fa-axe-battle"></i>
          <i *ngIf="o.name=='Armor'" class="far fa-helmet-battle"></i>
          <i *ngIf="o.name=='Mods'" class="far fa-book-spells"></i>
          <i *ngIf="o.name=='Consumable'" class="far fa-flask-potion"></i>
          <i *ngIf="o.name=='Material'" class="far fa-gem"></i>
          <span class="d-none d-md-inline"> {{o.name}}</span>
        </mat-button-toggle>
      </mat-button-toggle-group>

      <ng-container *ngIf="loading==false && selectedUser==null">
        <h2>Bungie Authentication Required</h2>
        <p style="max-width: 500px; text-align: left">You must grant this site access to your Bungie account for the
          site to access this info
          (gear management is part of the private API, like what DIM uses). Click the "Sign In" button on the upper
          right if you want to continue.</p>
      </ng-container>

      <div style="margin: 10px" [hidden]="selectedUser==null">
        <mat-form-field class="searchField">
          <input matInput #filter placeholder="Wildcard filter">
          <button mat-button matSuffix mat-icon-button aria-label="Help" (click)="showWildcardHelp()">
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>

        <anms-gear-toggle #markToggle iconClass="fas fa-tags" title="Tags" [choices]="markChoices" (change)="filterChanged()"
          [displayOptions]="[ItemType.Weapon, ItemType.Armor]" [currentItemType]="option.type">
        </anms-gear-toggle>

        <anms-gear-toggle #weaponTypeToggle iconClass="fas fa-swords" title="Type" [choices]="weaponTypeChoices"
          (change)="filterChanged()" [displayOptions]="[ItemType.Weapon]" [currentItemType]="option.type">
        </anms-gear-toggle>

        <anms-gear-toggle #armorTypeToggle iconClass="fas fa-helmet-battle" title="Type" [choices]="armorTypeChoices"
          (change)="filterChanged()" [displayOptions]="[ItemType.Armor]" [currentItemType]="option.type">
        </anms-gear-toggle>

        <anms-gear-toggle #modTypeToggle iconClass="fas fa-book-spells" title="Type" [choices]="modTypeChoices"
          (change)="filterChanged()" [displayOptions]="[ItemType.GearMod]" [currentItemType]="option.type">
        </anms-gear-toggle>
        <anms-gear-toggle #consumableTypeToggle iconClass="fas fa-flask-potion" title="Type" [choices]="consumableTypeChoices"
          (change)="filterChanged()" [displayOptions]="[ItemType.Consumable]" [currentItemType]="option.type">
        </anms-gear-toggle>
        <anms-gear-toggle #exchangeTypeToggle iconClass="fas fa-gem" title="Type" [choices]="exchangeTypeChoices"
          (change)="filterChanged()" [displayOptions]="[ItemType.ExchangeMaterial]" [currentItemType]="option.type">
        </anms-gear-toggle>
        <anms-gear-toggle #classTypeToggle iconClass="fas fa-hood-cloak" title="Class" [choices]="classTypeChoices"
          (change)="filterChanged()" [displayOptions]="[ItemType.Armor]" [currentItemType]="option.type">
        </anms-gear-toggle>
        <anms-gear-toggle #ownerToggle iconClass="fas fa-users" title="Owner" [choices]="ownerChoices" (change)="filterChanged()">
        </anms-gear-toggle>
        <anms-gear-toggle #rarityToggle iconClass="fas fa-balance-scale" title="Rarity" [choices]="rarityChoices"
          (change)="filterChanged()">
        </anms-gear-toggle>

        <button mat-button [matMenuTriggerFor]="menuShow"><i class="fas fa-plus-square"></i> Show</button>
        <mat-menu #menuShow="matMenu">
          <button mat-menu-item (click)="show(20)"><i *ngIf="size==20" class="fas fa-check"></i> 20 rows</button>
          <button mat-menu-item (click)="show(50)"><i *ngIf="size==50" class="fas fa-check"></i> 50 rows</button>
          <button mat-menu-item (click)="show(100)"><i *ngIf="size==100" class="fas fa-check"></i> 100 rows</button>
          <button mat-menu-item (click)="show(-1)"><i *ngIf="size==-1" class="fas fa-check"></i> All rows</button>
        </mat-menu>
        <a mat-button (click)="load()"><i class="fas fa-sync-alt"></i> Refresh</a>
        <a mat-button *ngIf="markService.dirty" (click)="markService.saveMarks()"><i class="fas fa-save"></i></a>
        <a mat-button *ngIf="filtersDirty==true" (click)="resetFilters()">
          <span class="fa-stack">
            <i class="fas fa-filter fa-stack-1x"></i>
            <i class="fas fa-ban fa-stack-2x warn-text"></i>
          </span>
        </a>

        {{gearToShow.length}} / {{total}}
      </div>
      <ng-container *ngIf="selectedUser!=null">
        <table class="gear-table mark-table">
          <thead>
            <tr>
              <th class="limited-gear-width">
                <a href="javascript:void(0)" (click)="sort('power')">Light</a>
              </th>
              <th class="limited-gear-width">
                <a href="javascript:void(0)" (click)="sort('name')">Name</a>
              </th>
              <th class="limited-gear-width hide-mobile-table-cell">
                <a href="javascript:void(0)" (click)="sort('typeName')">Type</a>
              </th>
              <th class="limited-gear-width hide-mobile-table-cell" *ngIf="option.type==ItemType.Weapon || option.type==ItemType.Armor">
                <a href="javascript:void(0)" (click)="sort('copies')">Copies</a>
              </th>
              <th class="limited-gear-width hide-mobile-table-cell" *ngIf="option.type==ItemType.Weapon || option.type==ItemType.Armor">
                <a href="javascript:void(0)" (click)="sort('masterwork')">Masterwork</a>
              </th>
              <th class="limited-gear-width hide-mobile-table-cell" *ngIf="option.type==ItemType.Weapon || option.type==ItemType.Armor">
                <a href="javascript:void(0)" (click)="sort('mod')">Mod</a>
              </th>
              <th class="hide-mobile-table-cell" *ngIf="option.type==ItemType.Weapon || option.type==ItemType.Armor">
                Sockets
              </th>

              <th class="limited-gear-width" *ngIf="option.type!=ItemType.Weapon && option.type!=ItemType.Armor">
                <a href="javascript:void(0)" (click)="sort('quantity')">Quantity</a>
              </th>
              <th class="tag-cell" *ngIf="option.type==ItemType.Weapon || option.type==ItemType.Armor">
                Tag
              </th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let i of gearToShow">
              <tr [ngClass]="i.mark">
                <td class="limited-gear-width">
                  <div *ngIf="i.icon!=null" class="item-image" [style.background-image]="'url(//www.bungie.net' + i.icon + ')'"
                    [class.masterworked]="i.masterworked">
                    <div *ngIf="i.power>0" class="primary-stat" [class.void]="i.damageType===DamageType.Void"
                      [class.arc]="i.damageType===DamageType.Arc" [class.solar]="i.damageType===DamageType.Thermal">
                      {{i.power}}
                    </div>
                    <div class="gear-lock">
                      <i *ngIf="i.locked" (click)="gearService.setLock(player, i, false)" class="fas fa-lock-alt"></i>
                      <i *ngIf="!i.locked && (i.type==ItemType.Weapon || i.type==ItemType.Armor)" (click)="gearService.setLock(player, i, true)"
                        class="fas fa-lock-open-alt"></i>
                    </div>
                    <div class="gear-equipped">
                      <i *ngIf="i.equipped" class="fas fa-shield-check" title="Equipped"></i>
                    </div>
                  </div>
                  <div>{{i.owner.label}}</div>
                  <div class="mobile-only-block">
                      <a href="javascript:void(0)" (click)="showCopies(i)">{{i.copies}} copies</a><br>
                  </div>
                </td>
                <td class="limited-gear-width">
                  <i *ngIf="i.godRoll" matTooltip="God roll! Search 'godroll' in the filter to find more of these."
                    class="fas fa-star accent-text"></i>
                  <a class="item-name" href="javascript:void(0)" [matTooltip]="i.desc" (click)="showItem(i)">{{i.name}}</a>
                  <span *ngIf="debugmode">[{{i.hash}}]</span>
                  <div class="options bordered">
                    <div class="item-option" *ngIf="i.canReallyEquip">
                      <a href="javascript:void(0);" (click)="gearService.equip(player, i)">Equip</a>
                    </div>
                    <ng-container *ngFor="let target of i.options">
                      <div class="item-option">
                        <a href="javascript:void(0);" (click)="gearService.transfer(player, i, target)">{{target.label}}</a>
                      </div>
                    </ng-container>
                  </div>
                  <div class="mobile-only-block">
                      <div *ngIf="i.masterwork!=null" [matTooltip]="i.masterwork.desc">
                        <code class="break-easy">{{i.masterwork.name}} {{i.masterwork.tier}}</code>
                        <mat-progress-bar mode="determinate" [color]="i.masterwork.tier>=10?'accent':'primary'" [value]="i.masterwork.tier*10"></mat-progress-bar>
                      </div>
  
                      <div *ngIf="i.mod!=null" [matTooltip]="i.mod.desc">
                        <code class="break-easy">{{i.mod.name}}</code>
                      </div>
                    </div>
  
                </td>
               
                <td class="limited-gear-width hide-mobile-table-cell">
                  {{i.typeName}}
                  <ng-container *ngIf="option.type == ItemType.Armor"><br>{{ClassAllowed[i.classAllowed]}}</ng-container>
                  <ng-container *ngIf="debugmode"><br>[{{i.inventoryBucket}}]</ng-container>

                </td>
                <td class="limited-gear-width hide-mobile-table-cell" *ngIf="option.type==ItemType.Weapon || option.type==ItemType.Armor">
                  <a href="javascript:void(0)" (click)="showCopies(i)">{{i.copies}}</a><br>
                  <span class="simple-caption" *ngIf="i.isRandomRoll">Random</span>
                  <span class="simple-caption" *ngIf="!i.isRandomRoll">Fixed</span>
                </td>
                <td class="limited-gear-width hide-mobile-table-cell" *ngIf="option.type==ItemType.Weapon || option.type==ItemType.Armor">
                  <div *ngIf="i.masterwork!=null" [matTooltip]="i.masterwork.desc">
                    <!-- <div *ngIf="i.masterwork.icon!=null" class="mod-icon transparent-icon" [style.background-image]="'url(//www.bungie.net' + i.masterwork.icon + ')'"></div>
                    <br> -->
                    {{i.masterwork.name}} {{i.masterwork.tier}} <ng-container *ngIf="debugmode">[{{i.masterwork.hash}}]</ng-container>

                    <mat-progress-bar mode="determinate" [color]="i.masterwork.tier>=10?'accent':'primary'" [value]="i.masterwork.tier*10"></mat-progress-bar>
                  </div>
                </td>
                <td class="limited-gear-width hide-mobile-table-cell" *ngIf="option.type==ItemType.Weapon || option.type==ItemType.Armor">
                  <div *ngIf="i.mod!=null" [matTooltip]="i.mod.desc">
                    <!-- <div *ngIf="i.mod.icon!=null" class="mod-icon transparent-icon" [style.background-image]="'url(//www.bungie.net' + i.mod.icon + ')'"></div>
                    <br> -->
                    {{i.mod.name}} <ng-container *ngIf="debugmode">[{{i.mod.hash}}]</ng-container>

                  </div>
                </td>
                <td class="hide-mobile-table-cell" *ngIf="option.type==ItemType.Weapon || option.type==ItemType.Armor">
                  <div *ngFor="let socket of i.sockets; last as isLastSocket" [class.bottom]="!isLastSocket">
                    <span *ngFor="let plug of socket.plugs; last as isLastPlug" [class.not-selected-plug]="!plug.active"
                      [matTooltip]="plug.desc">
                      <i *ngIf="plug.godRoll" matTooltip="God roll!" class="fas fa-star accent-text"></i>

                      <!-- <div *ngIf="plug.icon!=null" class="plug-icon transparent-icon" [style.background-image]="'url(//www.bungie.net' + plug.icon + ')'"></div> -->
                      {{plug.name}} <ng-container *ngIf="debugmode">[{{plug.hash}}]</ng-container>
                      <ng-container *ngIf="!isLastPlug">|</ng-container>
                    </span>
                  </div>
                </td>
                <td class="limited-gear-width" *ngIf="option.type!=ItemType.Weapon && option.type!=ItemType.Armor">
                  {{i.quantity}}
                </td>
                <td class="tag-cell" *ngIf="option.type==ItemType.Weapon || option.type==ItemType.Armor">
                  <div>
                    <button *ngFor="let mc of markService.markChoices" (click)="mark(mc.value,i)" mat-icon-button
                      [ngClass]="['tag-button',mc.value]">
                      <i [class]="mc.iconClass"></i>
                    </button>
                  </div>
                  <div>
                    <mat-form-field class="full-width">
                      <input matInput placeholder="Notes" maxlength="100" [(ngModel)]="i.notes" placeholder="Notes"
                        (change)="itemNotesChanged(i)">
                    </mat-form-field>
                  </div>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>

      </ng-container>
    </div>
    <div *ngIf="disableads===false" class="adRight">
      <small class="adText">Advertisement</small>
      <ng-adsense adFormat="vertical"></ng-adsense>
    </div>

  </div>
  <div *ngIf="disableads===false" class="adBottom">
    <small class="adText">Advertisement</small>
    <ng-adsense adSlot="7909243132" display="inline-block" width="336" height="280"></ng-adsense>
  </div>
</div>