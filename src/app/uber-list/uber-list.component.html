
<ng-container *ngIf="signedOnUserService.signedOnUser$|async as currUser; else notSignedIn">
  <ng-container *ngIf="signedOnUserService.player$|async as player; else noPlayerYet">
    <div class="flex-column" *ngIf="state.filteredRows$|async as rows">
      <div class="filter-container" *ngIf="state.toggleData as toggleData"> 
        <d2c-uber-list-toggle [state$]="state.toggleData.activityType$" > </d2c-uber-list-toggle>
        <d2c-uber-list-toggle [state$]="state.toggleData.cadence$" > </d2c-uber-list-toggle>
        <d2c-uber-list-toggle [state$]="state.toggleData.rewardTier$" > </d2c-uber-list-toggle>
        <d2c-uber-list-toggle [state$]="state.toggleData.reward$" > </d2c-uber-list-toggle>
        <d2c-uber-list-toggle [state$]="state.toggleData.owner$" > </d2c-uber-list-toggle>
      </div>
      <div class="filter-container">
        <mat-form-field class="wildcard-filter">
          <mat-label>Wildcard filter</mat-label>
          <input matInput #filter [(ngModel)]="state.visibleFilterText" placeholder="Wildcard filter" (keyup)="state.filterKeyUp$.next()">
          <button mat-button *ngIf="state.visibleFilterText" matSuffix mat-icon-button aria-label="Clear"
            (click)="state.visibleFilterText=null;state.filterKeyUp$.next()">
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>
        <div class="filter-row">
          <button mat-button>
            <fa-icon [icon]="iconService.fasSyncAlt" (click)="state.refresh()"></fa-icon>
          </button>
          <mat-checkbox ngDefaultControl>Hide Trials</mat-checkbox>
          <button mat-button *ngIf="(state.filtersDirty$|async)" (click)="state.resetFilters()">
            <fa-stack>
              <fa-icon [icon]="iconService.fasFilter" stackItemSize="1x"></fa-icon>
              <fa-icon [icon]="iconService.fasBan" stackItemSize="2x" class="warn-text"></fa-icon>
            </fa-stack>
          </button>
          <d2c-signed-on-loading-icon class="loading-indicator"></d2c-signed-on-loading-icon>
        </div>
      </div>

      <div>{{state.filterTags$|async|json}} | OR {{state.orMode}}</div>
      <table class="responsive-table">
        <thead>
          <tr>
            <th class="sticky">&nbsp;</th>
            <th class="sticky">Activity</th>
            <th class="sticky">Rewards</th>

            <th class="sticky" *ngFor="let char of player.characters">
              {{char.className}} - {{char.light}}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr class="hover-row" (click)="show(row)" *ngFor="let row of rows; trackBy: trackUberRow">
            <ng-container *ngIf="row.type=='pursuit'">
              <td>
                <ng-container *ngIf="row?.title?.icon as icon">
                  <div class="list-icon divider-border" [style.background-image]="'url(//www.bungie.net' + icon + ')'">
                  </div>
                </ng-container>
              </td>
              <td>
                {{row.title.name}}
              </td>
              <td>
                <div class="flex-row" *ngIf="row.title.values as rewards">
                  <div *ngFor="let r of rewards">
                    <img *ngIf="r.icon" [src]="'//www.bungie.net' + r.icon" class="reward-icon" loading="lazy"
                      [matTooltip]="(r.quantity > 0 ? r.quantity:'') + ' ' + r.name">
                      
                    <span *ngIf="debugmode|async">  {{r.hash}}</span>
                  </div>
                </div>

              </td>
              <td *ngFor="let char of player.characters">
                <ng-container *ngIf="row.characterEntries[char.id] as data">
                  <d2c-uber-pursuit-check [pursuit]="data"></d2c-uber-pursuit-check>
                </ng-container>
                
              </td>
            </ng-container>
            <ng-container *ngIf="row.type=='milestone'">
              <td>
                <ng-container *ngIf="row.desc?.displayProperties?.icon as icon">
                  <div class="list-icon divider-border" [class.invert]="icon.endsWith('png')"
                    [class.brighten]="icon.endsWith('jpg')"
                    [style.background-image]="'url(//www.bungie.net' + icon + ')'">
                  </div>                  
                  
                </ng-container>
              </td>
              <td>
                {{row.title.name}}
              </td>
              <td>
                <div class="flex-row" *ngIf="row.rewards as rewards">
                  <div *ngFor="let r of rewards">
                    <img *ngIf="r.icon" [src]="'//www.bungie.net' + r.icon" class="reward-icon" loading="lazy"
                      [matTooltip]="(r.quantity > 0 ? r.quantity:'') + ' ' + r.name">
                      <span *ngIf="debugmode|async">  {{r.hash}}</span>
                  </div>
                </div>
              </td>
              <td *ngFor="let char of player.characters">
                <ng-container *ngIf="row.characterEntries[char.id] as data">
                  <d2c-milestone-check [milestoneStatus]="data" [detailed]="true"></d2c-milestone-check>
                </ng-container>
                
              </td>
            </ng-container>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-container>
</ng-container>

<ng-template #notSignedIn>
  <d2c-sign-in-required></d2c-sign-in-required>
</ng-template>

<ng-template #noPlayerYet>
  <div class="center-spinner">
      <mat-spinner class="loading" class="center-spinner"></mat-spinner>
  </div>
</ng-template>